# 图书馆管理系统设计文档
## 1. 数据结构设计
### 1.1 图书节点（BookNode）
采用单向链表结构存储图书信息，核心字段定义如下：
```c
typedef struct Book {
    char isbn[20];        // 13位国际标准ISBN（禁止非数字字符）
    char title[100];      // 书名，支持中文，禁止空字符串
    char author[50];      // 作者名，支持多作者（逗号分隔）
    int stock;            // 库存量，≥0（借阅后保证非负）
    int loaned;           // 已借出数量，≥0（初始为0）
    struct Book* next;    // 单向链表指针，采用尾插法存储
} BookNode;
```
- 链表操作约束：添加图书时先检测ISBN冲突，冲突则返回错误码；删除/修改节点需保证链表指针完整性；
- 内存管理：所有`malloc`创建的节点需在`destroy_list`中对应`free`，通过Valgrind检测无内存泄漏。

### 1.2 借阅记录（LoanLog）
记录图书借阅行为，持久化到二进制文件`loan.bin`，支持导出为CSV格式`loan.csv`：
```c
typedef struct {
    char isbn[20];        // 关联图书ISBN
    int quantity;         // 借阅数量，≥1
    time_t timestamp;     // 借阅时间戳（系统时间）
} LoanLog;
```
- 持久化规则：采用追加写入模式，避免覆盖历史记录；加载记录时自动同步图书库存与借阅量；
- 验证方式：二进制文件每条记录固定占`20 + 4 + sizeof(time_t)`字节，可通过`hexdump`校验。

### 1.3 书籍信息JSON格式
定义`books.json`存储结构，包含元数据和书籍列表，便于人工查看与格式升级：
```json
{
    "metadata": {
        "version": "1.0",
        "created": "1726704000"
    },
    "books": [
        {
            "isbn": "9787532781234",
            "title": "百年孤独",
            "author": "加西亚·马尔克斯",
            "stock": 8,
            "loaned": 2
        },
        {
            "isbn": "9787020168892",
            "title": "活着",
            "author": "余华",
            "stock": 12,
            "loaned": 3
        }
    ]
}
```
- 格式分类：内部持久化JSON含元数据，外部导出JSON为纯书籍数组，满足不同使用场景。

## 2. 模块划分
系统分为4个核心模块，职责与依赖关系如下：

| 模块    | 核心职责                                                                 | 依赖模块         | 禁止操作                          |
|---------|--------------------------------------------------------------------------|------------------|-----------------------------------|
| `data`  | 链表核心操作（添加/删除/搜索图书、内存释放、字段更新）                   | 无               | 调用文件I/O、直接打印结果        |
| `logic` | 业务逻辑处理（库存/借阅量排序、生成统计报告、借书/还书/校验）            | `data`           | 操作文件、内存分配                |
| `store` | 文件I/O操作（借阅记录持久化、JSON加载/导出、CSV导出）                    | `data`           | 修改链表指针、处理用户输入        |
| `main`  | 用户界面与命令解析、系统初始化/退出（加载/保存数据）、最终联调和测试     | `data`/`logic`/`store` | 实现核心算法、直接操作链表节点    |

- 模块交互规则：`main`解析用户命令后调用对应模块接口，`store`/`logic`仅通过`data`接口操作链表，保证模块解耦。

## 3. 小组分工
| 成员     | 负责模块       | 具体任务                                  | 协助者                  |
|----------|----------------|-------------------------------------------|-------------------------|
| 刘绪辉   | `data`（data.h+data.c） | 定义数据结构和基础增删查改操作            | -                       |
| 张家懿   | `logic`（logic.h+logic.c） | 业务逻辑：借书、还书、查询、校验等        | -                       |
| 陈怡丞   | `store`（store.h+store.c） | 持久化：读写文件/JSON，加载和保存数据     | -                       |
| 戴华奇   | `main`（main.c） | 菜单/交互、调用各模块接口、最终联调和测试  | 刘绪辉、陈怡丞、张家懿  |

## 4. 关键算法设计
### 4.1 快速排序
基于链表实现快速排序，以`sort_by_stock`为例：
- 核心逻辑：选择头节点为基准，拆分为“小于基准”和“大于等于基准”的子链表，递归排序后合并；
- 复杂度：时间复杂度`O(nlogn)`，空间复杂度`O(logn)`（递归栈深度）；
- 边界处理：空链表/单节点直接返回，避免无效计算。

### 4.2 模糊搜索
遍历链表实时匹配书名/作者关键词，返回独立的结果链表：
- 匹配规则：支持部分匹配，结果链表单独分配内存（避免篡改原链表）；
- 约束：禁止全表扫描后过滤，需遍历过程中实时匹配。

### 4.3 JSON解析
禁止使用第三方库，采用手动解析字符串的方式：
- 核心步骤：读取文件→校验元数据版本→解析书籍数组→调用`add_book`添加图书；
- 错误处理：字段缺失时跳过该条记录并打印警告，保证程序鲁棒性。

## 5. 风险与应对
针对核心风险制定具体应对措施，保障系统稳定性：

| 风险          | 影响                 | 应对措施                                                                 |
|---------------|----------------------|--------------------------------------------------------------------------|
| 内存泄漏      | 程序崩溃、内存占用升高 | 强制实现`destroy_list`、Valgrind检测（`--leak-check=full`）、重点检查删除/搜索逻辑 |
| 链表操作错误  | 数据丢失、程序崩溃    | 所有链表函数首行检查空指针、单元测试覆盖空链表/删除唯一节点等边界场景      |
| 文件I/O失败   | 数据不一致           | 所有文件操作校验返回值、`perror`打印错误日志、持久化前检查磁盘权限        |
| 数据格式错误  | JSON加载失败         | JSON持久化后用`jsonlint`校验、ISBN输入时仅允许13位数字、加载时校验字段完整性 |